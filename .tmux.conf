# ==============================================================================
# TMUX CONFIGURATION
# ==============================================================================

# ------------------------------------------------------------------------------
# PREFIX
# ------------------------------------------------------------------------------
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# ------------------------------------------------------------------------------
# GENERAL SETTINGS
# ------------------------------------------------------------------------------
# Mouse support
set -g mouse on

# Reduce escape delay (responsive feel)
set -sg escape-time 10

# Faster key repetition
set -g repeat-time 300

# Start numbering at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Don't exit tmux when closing a session
set -g detach-on-destroy off

# Focus events (helps editors)
set -g focus-events on

# Larger scrollback buffer
set -g history-limit 50000

# ------------------------------------------------------------------------------
# TERMINAL & CLIPBOARD (Ghostty compatible)
# ------------------------------------------------------------------------------
set -g default-terminal "xterm-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ',xterm*:smcup@:rmcup@'

# Clipboard over SSH via OSC 52
set -g set-clipboard on
set -ga terminal-overrides ",xterm*:Ms=\\E]52;c;%p2%s\\7"

# Allow passthrough for apps
set -g allow-passthrough on

# ------------------------------------------------------------------------------
# WINDOW & PANE CREATION
# ------------------------------------------------------------------------------
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# ------------------------------------------------------------------------------
# NAVIGATION - PANES (Option + arrows, no prefix)
# ------------------------------------------------------------------------------
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Resize panes (Option + Shift + arrows)
bind -n M-S-Left resize-pane -L 2
bind -n M-S-Right resize-pane -R 2
bind -n M-S-Up resize-pane -U 2
bind -n M-S-Down resize-pane -D 2

# ------------------------------------------------------------------------------
# NAVIGATION - WINDOWS
# ------------------------------------------------------------------------------
# Cycle windows (Option + brackets)
bind -n M-] next-window
bind -n M-[ previous-window

# ------------------------------------------------------------------------------
# SESSION MANAGEMENT
# ------------------------------------------------------------------------------
# Session picker with preview
bind s choose-tree -sZ -O name
bind w choose-tree -wZ -O name

# Toggle last session
bind Space switch-client -l

# Cycle sessions
bind ( switch-client -p
bind ) switch-client -n

# New session with name
bind N command-prompt -p "New session name:" "new-session -s '%%'"

# Kill session with confirmation
bind X confirm-before -p "Kill session #S? (y/n)" "kill-session"

# ------------------------------------------------------------------------------
# COPY MODE & CLIPBOARD
# ------------------------------------------------------------------------------
# Enter copy mode
bind Enter copy-mode

# Mouse drag copies to clipboard
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Copy mode navigation
bind -T copy-mode Home send-keys -X history-top
bind -T copy-mode End send-keys -X history-bottom
bind -T copy-mode C-Up send-keys -X scroll-up
bind -T copy-mode C-Down send-keys -X scroll-down

# Quick search in scrollback
bind / copy-mode \; send-keys ?

# ------------------------------------------------------------------------------
# STATUS BAR
# ------------------------------------------------------------------------------
set -g status-position top
set -g status-style 'bg=#333333 fg=#ffffff'

# Left: session name
set -g status-left-length 30
set -g status-left '#[bg=#5577aa,fg=#ffffff,bold] #S #[default] '

# Right: hostname + time
set -g status-right-length 50
set -g status-right '#[fg=#888888]#H #[fg=#ffffff]%H:%M'

# Window tabs - show pane title (#T) if set by app, otherwise window name (#W)
set -g window-status-format ' #I:#{?#{==:#T,},#W,#T} '
set -g window-status-current-format '#[bg=#5577aa,fg=#ffffff,bold] #I:#{?#{==:#T,},#W,#T} #[default]'

# ------------------------------------------------------------------------------
# WINDOW TITLES
# ------------------------------------------------------------------------------
# Allow programs to set window title
set -g allow-rename on
set -g set-titles on
set -g set-titles-string '#S:#W - #T'

# Auto-rename to directory when no title set
setw -g automatic-rename on

# ------------------------------------------------------------------------------
# UTILITIES
# ------------------------------------------------------------------------------
# Reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Click session name (status-left) to open session picker
bind -n MouseDown1StatusLeft choose-tree -sZ -O name

# Help popup (press q to close)
bind ? display-popup -w 60 -h 30 -E "less -c << 'EOF'
    PANES
    ──────────────────────────
    Opt+arrows     Move between panes
    Opt+Shift+arr  Resize panes
    prefix+|       Split horizontal
    prefix+-       Split vertical

    WINDOWS
    ──────────────────────────
    prefix+c       New window
    prefix+,       Rename window
    prefix+&       Kill window
    Opt+[ / ]      Prev/next window
    prefix+1-9     Jump to window

    SESSIONS
    ──────────────────────────
    prefix+Space   Last session
    prefix+s       Session picker
    prefix+N       New session
    prefix+$       Rename session
    prefix+X       Kill session

    COPY/PASTE
    ──────────────────────────
    prefix+Enter   Copy mode
    prefix+/       Search scrollback
    Mouse drag     Copy to clipboard

    OTHER
    ──────────────────────────
    prefix+r       Reload config
    prefix+?       This help (q to close)
EOF"
